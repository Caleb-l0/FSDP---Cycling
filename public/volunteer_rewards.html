<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volunteer Rewards | HappyVolunteer</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="volunteer_rewards.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <div class="container">
    <div class="header-content">

      <a href="#" id="logoRedirect" class="logo">Happy Volunteer</a>

      <button class="nav-toggle" id="navToggle">
        <i class="fas fa-bars"></i>
      </button>

      <nav id="mainNav">
        <ul>
          <li><a href="volunteer-events.html">Booking</a></li>
          <li><a href="#">Community</a></li>
          <li><a href="volunteer_rewards.html">Reward</a></li>
          <li><a href="profilepage.html">Profile</a></li>
        </ul>
      </nav>

    </div>
  </div>
</header>

<div class="container">
  <h2>My Rewards</h2>
  <p><strong>Total Points:</strong> <span id="pointsDisplay">0</span></p>

  <div class="rewards-list" id="rewardsList" aria-live="polite">
    // Rewards will be loaded here//
  </div>
</div>

<footer>
  Â© 2025 HappyVolunteering
</footer>

<script>
  const token = localStorage.getItem("token");

  if (!token) {
    alert("Session expired, please log in again.");
    window.location.href = "login.html";
  }

  function decodeToken(token) {
    try {
      const payload = token.split(".")[1];
      return JSON.parse(atob(payload));
    } catch (e) {
      return null;
    }
  }

  const decoded = decodeToken(token);
  const userId = decoded?.id;

  if (!userId) {
    alert("Invalid session. Please log in again.");
    window.location.href = "login.html";
  }

  const pointsDisplay = document.getElementById("pointsDisplay");
  const rewardsList = document.getElementById("rewardsList");
  let currentPoints = 0;

  //  Fetch user total points
  fetch(`/api/rewards/${userId}`, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    currentPoints = data.points ?? 0;
    pointsDisplay.textContent = currentPoints;

    // 2 Display redeemable items
    const redeemableItems = [
      { name: "$5 NTUC Voucher", description: "$5 grocery voucher from all NTUC outlets", cost: 50 },
      { name: "$10 NTUC Voucher", description: "$10 grocery voucher from all NTUC outlets", cost: 100 },
      { name: "Volunteer T-Shirt", description: "Official HappyVolunteer T-Shirt", cost: 200 }
    ];

    redeemableItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "reward-item";
      div.innerHTML = `
        <h3>${item.name}</h3>
        <p>${item.description}</p>
        <p>Cost: ${item.cost} points</p>
        <button ${currentPoints < item.cost ? "disabled" : ""}>Redeem</button>
      `;
      rewardsList.appendChild(div);

      const button = div.querySelector("button");
      button.addEventListener("click", () => {
        if (currentPoints >= item.cost) {
          currentPoints -= item.cost;
          pointsDisplay.textContent = currentPoints;
          button.disabled = true;

          // send redemption to backend
          fetch(`/api/rewards/redeem`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ item: item.name, cost: item.cost })
          })
          .then(res => res.json())
          .then(resData => {
            console.log("Redeemed:", resData);
          })
          .catch(err => console.error("Redeem error:", err));

          alert(`You redeemed: ${item.name}`);
        }
      });
    });
  })
  .catch(err => {
    console.error("Rewards load error:", err);
    alert("Failed to load rewards.");
  });
</script>


</body>
</html>
