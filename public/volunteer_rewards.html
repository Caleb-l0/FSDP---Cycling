<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volunteer Rewards | HappyVolunteer</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <div class="container">
    <div class="header-content">

      <a href="#" id="logoRedirect" class="logo">Happy Volunteer</a>

      <button class="nav-toggle" id="navToggle">
        <i class="fas fa-bars"></i>
      </button>

      <nav id="mainNav">
        <ul>
          <li><a href="volunteer-events.html">Booking</a></li>
          <li><a href="#">Community</a></li>
          <li><a href="volunteer_rewards.html">Reward</a></li>
          <li><a href="profilepage.html">Profile</a></li>
        </ul>
      </nav>

    </div>
  </div>
</header>

<div class="container">
  <h2>My Rewards</h2>
  <p><strong>Total Points:</strong> <span id="pointsDisplay">0</span></p>

  <h3>Shop</h3>
  <div class="rewards-list" id="rewardsList" aria-live="polite">
    <!-- Shop items will load here -->
  </div>
</div>

<footer>
  Â© 2025 HappyVolunteering
</footer>

<script>
  // get token from localStorage
  const token = localStorage.getItem("token");
  if (!token) {
    alert("Session expired, please log in again.");
    window.location.href = "login.html";
  }

  function decodeToken(token) {
    try {
      const payload = token.split(".")[1];
      return JSON.parse(atob(payload));
    } catch (e) { return null; }
  }

  const decoded = decodeToken(token);
  const userId = decoded?.id;
  if (!userId) {
    alert("Invalid session. Please log in again.");
    window.location.href = "login.html";
  }

  const pointsDisplay = document.getElementById("pointsDisplay");
  const rewardsList = document.getElementById("rewardsList");
  let currentPoints = 0;

  //  Fetch user points + shop items 
  fetch(`/api/rewards/${userId}`, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    currentPoints = data.points ?? 0;
    pointsDisplay.textContent = currentPoints;

    const shopItems = data.shopItems || [];
    if (shopItems.length === 0) {
      rewardsList.innerHTML = "<p>No items in shop yet.</p>";
      return;
    }

    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "reward-item";
      div.innerHTML = `
        <h4>${item.Name}</h4>
        <p>${item.Description}</p>
        <p>Cost: ${item.Cost} points</p>
        <button ${currentPoints < item.Cost ? "disabled" : ""}>Redeem</button>
      `;
      rewardsList.appendChild(div);

      const button = div.querySelector("button");
      button.addEventListener("click", () => {
        if (currentPoints < item.Cost) return;

        fetch("/api/rewards/redeem", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ itemId: item.ItemID })
        })
        .then(res => res.json())
        .then(resData => {
          alert(resData.message || "Item redeemed!");
          currentPoints -= item.Cost;
          pointsDisplay.textContent = currentPoints;
          button.disabled = true;
        })
        .catch(err => {
          console.error("Redeem error:", err);
          alert("Failed to redeem item.");
        });
      });
    });
  })
  .catch(err => {
    console.error("Shop load error:", err);
    rewardsList.innerHTML = "<p>Failed to load shop.</p>";
  });
</script>

</body>
</html>