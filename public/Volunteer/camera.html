<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>QR Code Scanner - Auto Check-in</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    #video {
      width: 100%;
      max-width: 400px;
      height: 300px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #000;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-weight: bold;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .loading {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    #status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>üì± Scan QR Code for Auto Check-in</h2>
  <div id="status" class="info">üì∑ Position QR code in front of camera...</div>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const result = document.getElementById('result');
    const status = document.getElementById('status');
    const ctx = canvas.getContext('2d');
    
    // Get token from localStorage
    const token = localStorage.getItem('token');
    if (!token) {
      status.className = 'error';
      status.textContent = '‚ùå Please log in first';
      result.innerHTML = '<div class="error">Authentication required. Please log in and try again.</div>';
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 3000);
      return;
    }

    // Get user info from token
    function getUserFromToken() {
      try {
        const payloadBase64 = token
          .split(".")[1]
          .replace(/-/g, "+")
          .replace(/_/g, "/");
        const payloadJson = atob(payloadBase64);
        const payload = JSON.parse(payloadJson);
        return { id: payload.id, role: payload.role };
      } catch (err) {
        console.error("Token decode failed", err);
        return { id: null, role: null };
      }
    }

    const { id: userId, role: userRole } = getUserFromToken();
    
    if (!userId || userRole !== 'volunteer') {
      status.className = 'error';
      status.textContent = '‚ùå Unauthorized access';
      result.innerHTML = '<div class="error">Only volunteers can use QR check-in.</div>';
      return;
    }

    let isProcessing = false;
    let scannedCodes = new Set(); // Track scanned codes to prevent duplicates

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(scan);
        status.className = 'info';
        status.textContent = 'üì∑ Ready to scan QR codes...';
      })
      .catch(err => {
        status.className = 'error';
        status.textContent = '‚ùå Camera access denied';
        result.innerHTML = `<div class="error">Camera error: ${err.name}. Please allow camera access and refresh.</div>`;
      });

    async function scan() {
      if (video.readyState === video.HAVE_ENOUGH_DATA && !isProcessing) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
          // Prevent processing the same code multiple times
          if (scannedCodes.has(code.data)) {
            requestAnimationFrame(scan);
            return;
          }
          
          scannedCodes.add(code.data);
          isProcessing = true;
          
          status.className = 'loading';
          status.textContent = '‚è≥ Processing QR code...';
          result.innerHTML = '<div class="loading">üîÑ Checking in...</div>';
          
          try {
            // Extract event ID from QR code URL
            let eventId = null;
            
            if (code.data.includes('/events/')) {
              // Extract event ID from URL like /events/123/attendance
              const match = code.data.match(/\/events\/(\d+)/);
              if (match) {
                eventId = match[1];
              }
            } else if (/^\d+$/.test(code.data)) {
              // If QR code contains just the event ID
              eventId = code.data;
            }
            
            if (!eventId) {
              throw new Error('Invalid QR code format. Please scan a valid event QR code.');
            }
            
            console.log(`Auto check-in: User ${userId} for Event ${eventId}`);
            
            // First, check if user is already checked in
            const checkStatusResponse = await fetch(
              `https://fsdp-cycling-ltey.onrender.com/events/${eventId}/attendance-status`,
              {
                method: "GET",
                headers: {
                  "Authorization": `Bearer ${token}`,
                  "Content-Type": "application/json"
                }
              }
            );

            let checkStatusData = { isCheckedIn: false };
            try {
              checkStatusData = await checkStatusResponse.json();
            } catch (e) {
              // If status endpoint doesn't exist, proceed with check-in
              console.log('Status check failed, proceeding with check-in attempt');
            }

            let checkInResponse;
            let checkInData;
            let action = '';

            // If user is already checked in, perform check-out
            if (checkStatusData.isCheckedIn || (checkStatusData.message && checkStatusData.message.includes('already checked in'))) {
              action = 'check-out';
              checkInResponse = await fetch(
                `https://fsdp-cycling-ltey.onrender.com/events/${eventId}/checkout`,
                {
                  method: "POST",
                  headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                  }
                }
              );
            } else {
              // First time or not checked in, perform check-in
              action = 'check-in';
              checkInResponse = await fetch(
                `https://fsdp-cycling-ltey.onrender.com/events/${eventId}/checkin`,
                {
                  method: "POST",
                  headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                  }
                }
              );
            }

            checkInData = await checkInResponse.json();
            
            if (checkInResponse.ok) {
              if (action === 'check-in') {
                status.className = 'success';
                status.textContent = '‚úÖ Check-in successful!';
                result.innerHTML = `
                  <div class="success">
                    <h3>üéâ Successfully Checked In!</h3>
                    <p><strong>Event ID:</strong> ${eventId}</p>
                    <p><strong>User ID:</strong> ${userId}</p>
                    <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Message:</strong> ${checkInData.message || 'Check-in completed successfully'}</p>
                    <hr>
                    <p>üì± Scan again to check out</p>
                  </div>
                `;
                
                // Add reward points notification if mentioned
                if (checkInData.pointsAwarded) {
                  result.innerHTML += `<p class="success">üèÜ ${checkInData.pointsAwarded} points awarded!</p>`;
                }
              } else {
                status.className = 'success';
                status.textContent = '‚úÖ Check-out successful!';
                result.innerHTML = `
                  <div class="success">
                    <h3>üëã Successfully Checked Out!</h3>
                    <p><strong>Event ID:</strong> ${eventId}</p>
                    <p><strong>User ID:</strong> ${userId}</p>
                    <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Message:</strong> ${checkInData.message || 'Check-out completed successfully'}</p>
                    <hr>
                    <p>‚úÖ Thank you for participating!</p>
                  </div>
                `;
                
                // Add reward points notification if mentioned
                if (checkInData.pointsAwarded) {
                  result.innerHTML += `<p class="success">üèÜ ${checkInData.pointsAwarded} points awarded!</p>`;
                }
              }
              
            } else {
              // Handle specific error cases
              if (checkInData.message && checkInData.message.includes('already checked in')) {
                // If check-in says already checked in, try check-out
                try {
                  const checkOutResponse = await fetch(
                    `https://fsdp-cycling-ltey.onrender.com/events/${eventId}/checkout`,
                    {
                      method: "POST",
                      headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                      }
                    }
                  );
                  
                  const checkOutData = await checkOutResponse.json();
                  
                  if (checkOutResponse.ok) {
                    status.className = 'success';
                    status.textContent = '‚úÖ Check-out successful!';
                    result.innerHTML = `
                      <div class="success">
                        <h3>üëã Successfully Checked Out!</h3>
                        <p><strong>Event ID:</strong> ${eventId}</p>
                        <p><strong>User ID:</strong> ${userId}</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                        <p><strong>Message:</strong> ${checkOutData.message || 'Check-out completed successfully'}</p>
                        <hr>
                        <p>‚úÖ Thank you for participating!</p>
                      </div>
                    `;
                    
                    if (checkOutData.pointsAwarded) {
                      result.innerHTML += `<p class="success">üèÜ ${checkOutData.pointsAwarded} points awarded!</p>`;
                    }
                  } else {
                    throw new Error(checkOutData.message || 'Check-out failed');
                  }
                } catch (checkoutError) {
                  throw new Error('Already checked in but check-out failed: ' + checkoutError.message);
                }
              } else if (checkInData.message && checkInData.message.includes('already checked out')) {
                status.className = 'info';
                status.textContent = '‚ÑπÔ∏è Already checked out';
                result.innerHTML = `
                  <div class="info">
                    <h3>‚úÖ Already Checked Out</h3>
                    <p>You have already checked out for this event.</p>
                    <p><strong>Event ID:</strong> ${eventId}</p>
                    <p><strong>User ID:</strong> ${userId}</p>
                    <hr>
                    <p>‚úÖ Thank you for participating!</p>
                  </div>
                `;
              } else {
                throw new Error(checkInData.message || `${action} failed`);
              }
            }
            
          } catch (error) {
            console.error('Check-in error:', error);
            status.className = 'error';
            status.textContent = '‚ùå Check-in failed';
            result.innerHTML = `
              <div class="error">
                <h3>‚ùå Check-in Failed</h3>
                <p><strong>Error:</strong> ${error.message}</p>
                <p>Please try again or contact event coordinator.</p>
                <hr>
                <p><small>QR Code Data: ${code.data}</small></p>
              </div>
            `;
          } finally {
            isProcessing = false;
            // Reset after 3 seconds to allow scanning again for check-out
            setTimeout(() => {
              if (status.className === 'success' || status.className === 'error') {
                status.className = 'info';
                status.textContent = 'üì∑ Ready to scan again...';
                scannedCodes.clear(); // Allow re-scanning the same code for check-out
              }
            }, 3000);
          }
        }
      }
      requestAnimationFrame(scan);
    }
  </script>
</body>
</html>

