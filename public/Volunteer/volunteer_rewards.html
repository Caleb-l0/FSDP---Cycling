<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volunteer Rewards | HappyVolunteer</title>
    <link rel="stylesheet" href="../homepage.css">
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header class="hv-header">
    <div class="container hv-header-content">

        <div class="hv-logo">
                <a href="./homepage_login_volunteer.html" style="text-decoration: none; color: inherit;">
                Happy Volunteer
            </a>
        </div>

        <nav id="mainNav">
            <ul>
                <li><a href="./volunteer-events.html">Booking</a></li>
                <li><a href="#">Community</a></li>
                <li><a href="./volunteer_rewards.html">Reward</a></li>
                <li><a href="#">Friends</a></li>
                <li><a href="../Profile/profilepage.html">Profile</a></li>
            </ul>
        </nav>


        <button class="hv-nav-toggle" id="hvNavToggle">
            <i class="fas fa-bars"></i>
        </button>

        <nav class="hv-nav" id="hvNav">
            <ul>
                <li><a href="./volunteer-events.html">Booking</a></li>
                <li><a href="#">Community</a></li>
                <li><a href="./volunteer_rewards.html">Reward</a></li>
                <li><a href="#">Friends</a></li>
                <li><a href="../Profile/profilepage.html">Profile</a></li>
            </ul>
        </nav>


    </div>
</header>

<div class="container">
  <h2>My Rewards</h2>
  <p><strong>Total Points:</strong> <span id="pointsDisplay">0</span></p>

  <h3>Shop</h3>
  <div class="rewards-list" id="rewardsList" aria-live="polite">
    <!-- Shop items will load here -->
  </div>
</div>

<div id="transactionHistory"></div>
<!--Transection History obv-->


<footer>
    <div class="container">
        <div class="footer-content">

            <div class="footer-column">
                <h3>Happy Volunteer</h3>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Our Team</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">News & Updates</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Information</h3>
                <ul>
                    <li><a href="#">FAQ</a></li>
                    <li><a href="#">Blog</a></li>
                    <li><a href="#">Resources</a></li>
                    <li><a href="#">Event Calendar</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Contact</h3>
                <ul>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">Support Center</a></li>
                    <li><a href="#">Partnerships</a></li>
                    <li><a href="#">Feedback</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Legal</h3>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Use</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                    <li><a href="#">Disclaimer</a></li>
                </ul>
            </div>

        </div>

        <div class="copyright">
            <p>&copy; 2025 Happy Volunteer. All rights reserved.</p>
        </div>
    </div>
</footer>



<script>
  // get token from localStorage
  const token = localStorage.getItem("token");
  if (!token) {
    alert("Session expired, please log in again.");
    window.location.href = "login.html";
  }

  function decodeToken(token) {
    try {
      const payload = token.split(".")[1];
      return JSON.parse(atob(payload));
    } catch (e) { return null; }
  }

  const decoded = decodeToken(token);
  const userId = decoded?.id;
  if (!userId) {
    alert("Invalid session. Please log in again.");
    window.location.href = "login.html";
  }

  const pointsDisplay = document.getElementById("pointsDisplay");
  const rewardsList = document.getElementById("rewardsList");
  let currentPoints = 0;

  //  Fetch user points + shop items 
  fetch(`http://localhost:3000/rewards/${userId}`, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    currentPoints = data.points ?? 0;
    pointsDisplay.textContent = currentPoints;

    const shopItems = data.shopItems || [];
    if (shopItems.length === 0) {
      rewardsList.innerHTML = "<p>No items in shop yet.</p>";
      return;
    }

    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "reward-item";
      div.innerHTML = `
        <h4>${item.Name}</h4>
        <p>${item.Description}</p>
        <p>Cost: ${item.Cost} points</p>
        <button ${currentPoints < item.Cost ? "disabled" : ""}>Redeem</button>
      `;
      rewardsList.appendChild(div);

      const button = div.querySelector("button");
      button.addEventListener("click", () => {
        if (currentPoints < item.Cost) return;

        fetch("/api/rewards/redeem", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ itemId: item.ItemID })
        })
        .then(res => res.json())
        .then(resData => {
          alert(resData.message || "Item redeemed!");
          currentPoints -= item.Cost;
          pointsDisplay.textContent = currentPoints;
          button.disabled = true;
        })
        .catch(err => {
          console.error("Redeem error:", err);
          alert("Failed to redeem item.");
        });
      });
    });
  })
  .catch(err => {
    console.error("Shop load error:", err);
    rewardsList.innerHTML = "<p>Failed to load shop.</p>";
  });


    async function loadHistory() {
  const res = await fetch(`http://localhost:3000/rewards/history/${userId}`);
  const data = await res.json();

  let html = "<h2>Your Redemption History</h2>";

  if (data.length === 0) {
    html += "<p>No redemptions yet.</p>";
  } else {
    html += "<ul>";
    data.forEach(item => {
      html += `
        <li>
          ${item.ItemName} â€” ${item.Points} points
          <span style="color:#777;">(${new Date(item.RedeemedAt).toLocaleString()})</span>
          <button>View Details</button>
        </li>
      `;
    });
    html += "</ul>";
  }

  document.getElementById("transactionHistory").innerHTML = html;
  // Attach modal listeners to each "View Details" button
const historyButtons = document.querySelectorAll("#transactionHistory button");

historyButtons.forEach((btn, index) => {
  btn.addEventListener("click", () => {
    const item = data[index];

    // Fill modal
    document.getElementById("vItem").textContent = item.ItemName;
    document.getElementById("vPoints").textContent = item.Points;
    document.getElementById("vDate").textContent = new Date(item.RedeemedAt).toLocaleString();
    document.getElementById("vCode").textContent = item.VoucherCode ?? "N/A";

    // Create QR
    const qrContainer = document.getElementById("qrCode");
    qrContainer.innerHTML = "";
    new QRCode(qrContainer, item.VoucherCode ?? "N/A");

    // Show modal
    document.getElementById("voucherModal").style.display = "flex";
  });
});

}

loadHistory();
</script>

<!-- Voucher Modal -->
<div id="voucherModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;">
  
  <div style="
    background:white;
    padding:20px;
    border-radius:10px;
    width:300px;
    text-align:center;">
    
    <h2>Voucher Details</h2>
    <p><strong>Item:</strong> <span id="vItem"></span></p>
    <p><strong>Points:</strong> <span id="vPoints"></span></p>
    <p><strong>Date:</strong> <span id="vDate"></span></p>
    <p><strong>Voucher Code:</strong> <span id="vCode"></span></p>
    <div id="qrCode" style="display:flex; justify-content:center; margin:10px 0;"></div>


    

    <button onclick="document.getElementById('voucherModal').style.display='none'">
      Close
    </button>
  </div>
</div>

<!-- QR generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script src="https://cdn.botpress.cloud/webchat/v3.3/inject.js" defer></script>
<script src="https://files.bpcontent.cloud/2025/11/22/14/20251122142820-IG7UQ29V.js" defer></script>
 <script src="../Translation.js"></script>
  <script src="../homepage.js"></script>

</body>
</html>