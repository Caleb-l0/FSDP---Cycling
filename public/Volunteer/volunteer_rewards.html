<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volunteer Rewards | HappyVolunteer</title>

   <link rel="stylesheet" href="../homepage.css">
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header class="hv-header">
    <div class="container hv-header-content">

        <div class="hv-logo">
                <a href="./homepage_login_volunteer.html" style="text-decoration: none; color: inherit;">
                Happy Volunteer
            </a>
        </div>

        <nav id="mainNav">
            <ul>
                <li><a href="./volunteer-events.html">Booking</a></li>
                <li><a href="./volunteer_community_page.html">Community</a></li>
                <li><a href="./volunteer_rewards.html">Reward</a></li>
                <li><a href="./Volunteer_friend.html">Friends</a></li>
                <li><a href="../Profile/profilepage.html">Profile</a></li>
            </ul>
        </nav>


        <button class="hv-nav-toggle" id="hvNavToggle">
          
            <i class="fas fa-bars"></i>
        </button>

        <nav class="hv-nav" id="hvNav">
            
            <ul>
                <li><a href="./volunteer-events.html">Booking</a></li>
                <li><a href="./volunteer_community_page.html">Community</a></li>
                <li><a href="./volunteer_rewards.html">Reward</a></li>
                <li><a href="./Volunteer_friend.html">Friends</a></li>
                <li><a href="../Profile/profilepage.html">Profile</a></li>
            </ul>
        </nav>


    </div>
</header>

<div class="container">

  <div class="rewards-summary">
    <div class="summary-left">
      <h2>My Rewards</h2>
      <div class="summary-points">
        You have
        <span id="pointsDisplay">0</span>
        points
      </div>
    </div>

    <div class="summary-right">
      <button class="btn-my-rewards" onclick="scrollToHistory()">
        üìú View My Rewards
      </button>
    </div>
  </div>

  <h3 class="shop-title">Rewards Shop</h3>


  <h3>Shop</h3>
  <div class="rewards-list" id="rewardsList" aria-live="polite">
    <!-- Shop items will load here -->
  </div>
</div>

<section id="transactionHistory" class="history-card" aria-label="Redemption History">
  <div class="history-head">
    <h3 class="history-title">Redemption History</h3>
    <button id="toggleHistory" class="history-toggle" type="button" aria-expanded="true" aria-controls="historyBody">
      <span class="history-toggle-label">Hide</span>
      <span class="history-toggle-icon" aria-hidden="true">‚ñæ</span>
    </button>
  </div>

  <div id="historyBody" class="history-body">
    <div id="historyContent" aria-live="polite"></div>
  </div>
</section>
<!--Transection History obv-->

<footer>
    <div class="container">
        <div class="footer-content">

            <div class="footer-column">
                <h3>Happy Volunteer</h3>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Our Team</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">News & Updates</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Information</h3>
                <ul>
                    <li><a href="#">FAQ</a></li>
                    <li><a href="#">Blog</a></li>
                    <li><a href="#">Resources</a></li>
                    <li><a href="#">Event Calendar</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Contact</h3>
                <ul>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">Support Center</a></li>
                    <li><a href="#">Partnerships</a></li>
                    <li><a href="#">Feedback</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Legal</h3>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Use</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                    <li><a href="#">Disclaimer</a></li>
                </ul>
            </div>

        </div>

        <div class="copyright">
            <p>&copy; 2025 Happy Volunteer. All rights reserved.</p>
        </div>
    </div>
</footer>


<script src="../homepage.js">
  
</script>
<script>
  // get token from localStorage

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Session expired, please log in again.");
    window.location.href = "login.html";
  }

  function decodeToken(token) {
    try {
      const payload = token.split(".")[1];
      return JSON.parse(atob(payload));
    } catch (e) { return null; }
  }

  const decoded = decodeToken(token);
  const userId = decoded?.id;
  if (!userId) {
    alert("Invalid session. Please log in again.");
    window.location.href = "login.html";
  }

  const pointsDisplay = document.getElementById("pointsDisplay");
  const rewardsList = document.getElementById("rewardsList");
  let currentPoints = 0;

  function scrollToHistory(){
  const section = document.getElementById("transactionHistory");
  if (!section) return;


  setHistoryCollapsed(false);

  section.scrollIntoView({ behavior: "smooth", block: "start" });
}


  if (rewardsList) {
    rewardsList.innerHTML = `
      <div class="reward-skeleton" aria-hidden="true">
        <div class="rsk-hero"></div>
        <div class="rsk-body">
          <div class="rsk-line rsk-line--title"></div>
          <div class="rsk-line"></div>
          <div class="rsk-line"></div>
          <div class="rsk-pill"></div>
        </div>
      </div>
      <div class="reward-skeleton" aria-hidden="true">
        <div class="rsk-hero"></div>
        <div class="rsk-body">
          <div class="rsk-line rsk-line--title"></div>
          <div class="rsk-line"></div>
          <div class="rsk-line"></div>
          <div class="rsk-pill"></div>
        </div>
      </div>
      <div class="reward-skeleton" aria-hidden="true">
        <div class="rsk-hero"></div>
        <div class="rsk-body">
          <div class="rsk-line rsk-line--title"></div>
          <div class="rsk-line"></div>
          <div class="rsk-line"></div>
          <div class="rsk-pill"></div>
        </div>
      </div>
    `;
  }

  //  Fetch user points + shop items 
  fetch(`https://fsdp-cycling-ltey.onrender.com/rewards/${userId}`, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    currentPoints = data.points ?? 0;
    pointsDisplay.textContent = currentPoints;

const shopItems = data.shopItems || [];
if (shopItems.length === 0) {
  rewardsList.innerHTML = "<p>No items in shop yet.</p>";
  return;
}


rewardsList.innerHTML = "";

shopItems.forEach(item => {
  const div = document.createElement("div");
  div.className = "reward-item";
  div.innerHTML = `
    <h4>${item.Name}</h4>
    <p>${item.Description}</p>
    <p>Cost: ${item.Cost} points</p>
    <button ${currentPoints < item.Cost ? "disabled" : ""}>Redeem</button>
    <div class="redeem-feedback" aria-live="polite"></div>
  `;
  rewardsList.appendChild(div);

      const button = div.querySelector("button");
      const feedback = div.querySelector(".redeem-feedback");
      button.addEventListener("click", () => {
        if (currentPoints < item.Cost) return;

        if (feedback) {
          feedback.textContent = '';
          feedback.classList.remove('is-success', 'is-error');
        }

        button.disabled = true;
        button.classList.add('is-loading');
        button.dataset.originalText = button.textContent;
        button.textContent = 'Redeeming...';

        fetch("https://fsdp-cycling-ltey.onrender.com/rewards/redeem", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ itemId: item.ItemID })
        })
        .then(res => res.json())
        .then(resData => {
          if (feedback) {
            feedback.textContent = resData.message || 'Redeemed successfully.';
            feedback.classList.add('is-success');
          }
          currentPoints -= item.Cost;
          pointsDisplay.textContent = currentPoints;
          button.classList.remove('is-loading');
          button.textContent = 'Redeemed';
          button.disabled = true;
        })
        .catch(err => {
          console.error("Redeem error:", err);
          if (feedback) {
            feedback.textContent = 'Failed to redeem item.';
            feedback.classList.add('is-error');
          }
          button.classList.remove('is-loading');
          button.disabled = false;
          button.textContent = button.dataset.originalText || 'Redeem';
        });
      });
    });
  })
  .catch(err => {
    console.error("Shop load error:", err);
    rewardsList.innerHTML = "<p>Failed to load shop.</p>";
  });


  const historyContent = document.getElementById("historyContent");
  const historyBody = document.getElementById("historyBody");
  const historyToggle = document.getElementById("toggleHistory");

  function setHistoryCollapsed(isCollapsed) {
    if (!historyBody || !historyToggle) return;
    historyBody.classList.toggle('is-collapsed', isCollapsed);
    historyToggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
    const label = historyToggle.querySelector('.history-toggle-label');
    if (label) label.textContent = isCollapsed ? 'Show' : 'Hide';
  }

  if (historyToggle) {
    historyToggle.addEventListener('click', () => {
      const isCollapsed = historyBody?.classList.contains('is-collapsed');
      setHistoryCollapsed(!isCollapsed);
    });
  }

  function renderHistorySkeleton(count = 3) {
    if (!historyContent) return;
    let html = '<div class="history-skeleton" aria-hidden="true">';
    for (let i = 0; i < count; i += 1) {
      html += `
        <div class="hsk-row">
          <div class="hsk-line hsk-line--title"></div>
          <div class="hsk-line"></div>
          <div class="hsk-line hsk-line--short"></div>
        </div>
      `;
    }
    html += '</div>';
    historyContent.innerHTML = html;
  }

  function renderEmptyHistory() {
    if (!historyContent) return;
    historyContent.innerHTML = `
      <div class="history-empty" role="status">
        <div class="history-empty-icon" aria-hidden="true">üéÅ</div>
        <div class="history-empty-title">No redemptions yet</div>
        <div class="history-empty-sub">Your redeemed vouchers will appear here.</div>
      </div>
    `;
  }

  function renderHistoryList(data) {
    if (!historyContent) return;
    historyContent.innerHTML = `
      <ul class="history-list">
        ${data.map((item, index) => `
          <li class="history-item">
            <div class="history-item-main">
              <div class="history-item-name">${item.ItemName}</div>
              <div class="history-item-meta">${item.Points} points ¬∑ ${new Date(item.RedeemedAt).toLocaleString()}</div>
            </div>
            <button class="history-view" type="button" data-index="${index}">View</button>
          </li>
        `).join('')}
      </ul>
    `;
  }

  async function loadHistory() {
    renderHistorySkeleton(3);

    try {
      const res = await fetch(`https://fsdp-cycling-ltey.onrender.com/rewards/history/${userId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) throw new Error('Failed to load history');
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        renderEmptyHistory();
        return;
      }

      renderHistoryList(data);

      const historyButtons = document.querySelectorAll(".history-view");
      historyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const index = Number(btn.dataset.index);
          const item = data[index];
          if (!item) return;

          document.getElementById("vItem").textContent = item.ItemName;
          document.getElementById("vPoints").textContent = item.Points;
          document.getElementById("vDate").textContent = new Date(item.RedeemedAt).toLocaleString();
          document.getElementById("vCode").textContent = item.VoucherCode ?? "N/A";

          const qrContainer = document.getElementById("qrCode");
          qrContainer.innerHTML = "";
          new QRCode(qrContainer, item.VoucherCode ?? "N/A");

          document.getElementById("voucherModal").style.display = "flex";
        });
      });
    } catch (e) {
      if (historyContent) {
        historyContent.innerHTML = '<p class="history-error">Failed to load redemption history.</p>';
      }
    }
  }

  loadHistory();
</script>

<!-- Voucher Modal -->
<div id="voucherModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;">
  
  <div style="
    background:white;
    padding:20px;
    border-radius:10px;
    width:300px;
    text-align:center;">
    
    <h2>Voucher Details</h2>
    <p><strong>Item:</strong> <span id="vItem"></span></p>
    <p><strong>Points:</strong> <span id="vPoints"></span></p>
    <p><strong>Date:</strong> <span id="vDate"></span></p>
    <p><strong>Voucher Code:</strong> <span id="vCode"></span></p>
    <div id="qrCode" style="display:flex; justify-content:center; margin:10px 0;"></div>


    

    <button onclick="document.getElementById('voucherModal').style.display='none'">
      Close
    </button>
  </div>
</div>

<!-- QR generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

 <script src="https://cdn.botpress.cloud/webchat/v3.5/inject.js"></script>
<script src="https://files.bpcontent.cloud/2025/11/22/14/20251122142820-IG7UQ29V.js" defer></script>

</body>
</html>
