<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volunteer Rewards | HappyVolunteer</title>

   <link rel="stylesheet" href="../homepage.css">
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header class="hv-header">
    <div class="container hv-header-content">

        <div class="hv-logo">
                <a href="./homepage_login_volunteer.html" style="text-decoration: none; color: inherit;">
                Happy Volunteer
            </a>
        </div>

        <nav id="mainNav">
            <ul>
                <li><a href="./volunteer-events.html">Booking</a></li>
                <li><a href="./volunteer_community_page.html">Community</a></li>
                <li><a href="./volunteer_rewards.html">Reward</a></li>
                <li><a href="./Volunteer_friend.html">Friends</a></li>
                <li><a href="../Profile/profilepage.html">Profile</a></li>
            </ul>
        </nav>


        <button class="hv-nav-toggle" id="hvNavToggle">
          
            <i class="fas fa-bars"></i>
        </button>

        <nav class="hv-nav" id="hvNav">
            
            <ul>
                <li><a href="./volunteer-events.html">Booking</a></li>
                <li><a href="./volunteer_community_page.html">Community</a></li>
                <li><a href="./volunteer_rewards.html">Reward</a></li>
                <li><a href="./Volunteer_friend.html">Friends</a></li>
                <li><a href="../Profile/profilepage.html">Profile</a></li>
            </ul>
        </nav>


    </div>
</header>

<div class="container">
  <h2>My Rewards</h2>
  <p><strong>Total Points:</strong> <span id="pointsDisplay">0</span></p>

  <h3>Shop</h3>
  <div class="rewards-list" id="rewardsList" aria-live="polite">
    <!-- Shop items will load here -->
  </div>
</div>

<div id="transactionHistory"></div>
<!--Transection History obv-->

<footer>
  © 2025 HappyVolunteering
</footer>



<script src="../homepage.js">
  
</script>
<script>
  // get token from localStorage



  function decodeToken(token) {
    try {
      const payload = token.split(".")[1];
      return JSON.parse(atob(payload));
    } catch (e) { return null; }
  }

  const decoded = decodeToken(token);
  const userId = decoded?.id;
  if (!userId) {
    alert("Invalid session. Please log in again.");
    window.location.href = "login.html";
  }

  const pointsDisplay = document.getElementById("pointsDisplay");
  const rewardsList = document.getElementById("rewardsList");
  let currentPoints = 0;

  if (rewardsList) {
    rewardsList.innerHTML = `
      <div class="reward-skeleton" aria-hidden="true">
        <div class="rsk-hero"></div>
        <div class="rsk-body">
          <div class="rsk-line rsk-line--title"></div>
          <div class="rsk-line"></div>
          <div class="rsk-line"></div>
          <div class="rsk-pill"></div>
        </div>
      </div>
      <div class="reward-skeleton" aria-hidden="true">
        <div class="rsk-hero"></div>
        <div class="rsk-body">
          <div class="rsk-line rsk-line--title"></div>
          <div class="rsk-line"></div>
          <div class="rsk-line"></div>
          <div class="rsk-pill"></div>
        </div>
      </div>
      <div class="reward-skeleton" aria-hidden="true">
        <div class="rsk-hero"></div>
        <div class="rsk-body">
          <div class="rsk-line rsk-line--title"></div>
          <div class="rsk-line"></div>
          <div class="rsk-line"></div>
          <div class="rsk-pill"></div>
        </div>
      </div>
    `;
  }

  //  Fetch user points + shop items 
  fetch(`https://fsdp-cycling-ltey.onrender.com/rewards/${userId}`, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    currentPoints = data.points ?? 0;
    pointsDisplay.textContent = currentPoints;

    const shopItems = data.shopItems || [];
    if (shopItems.length === 0) {
      rewardsList.innerHTML = "<p>No items in shop yet.</p>";
      return;
    }

    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "reward-item";
      div.innerHTML = `
        <h4>${item.Name}</h4>
        <p>${item.Description}</p>
        <p>Cost: ${item.Cost} points</p>
        <button ${currentPoints < item.Cost ? "disabled" : ""}>Redeem</button>
        <div class="redeem-feedback" aria-live="polite"></div>
      `;
      rewardsList.appendChild(div);

      const button = div.querySelector("button");
      const feedback = div.querySelector(".redeem-feedback");
      button.addEventListener("click", () => {
        if (currentPoints < item.Cost) return;

        if (feedback) {
          feedback.textContent = '';
          feedback.classList.remove('is-success', 'is-error');
        }

        button.disabled = true;
        button.classList.add('is-loading');
        button.dataset.originalText = button.textContent;
        button.textContent = 'Redeeming...';

        fetch("https://fsdp-cycling-ltey.onrender.com/rewards/redeem", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ itemId: item.ItemID })
        })
        .then(res => res.json())
        .then(resData => {
          if (feedback) {
            feedback.textContent = resData.message || 'Redeemed successfully.';
            feedback.classList.add('is-success');
          }
          currentPoints -= item.Cost;
          pointsDisplay.textContent = currentPoints;
          button.classList.remove('is-loading');
          button.textContent = 'Redeemed';
          button.disabled = true;
        })
        .catch(err => {
          console.error("Redeem error:", err);
          if (feedback) {
            feedback.textContent = 'Failed to redeem item.';
            feedback.classList.add('is-error');
          }
          button.classList.remove('is-loading');
          button.disabled = false;
          button.textContent = button.dataset.originalText || 'Redeem';
        });
      });
    });
  })
  .catch(err => {
    console.error("Shop load error:", err);
    rewardsList.innerHTML = "<p>Failed to load shop.</p>";
  });


    async function loadHistory() {
  const res = await fetch(`https://fsdp-cycling-ltey.onrender.com/rewards/history/${userId}`, {
  headers: {
    "Authorization": `Bearer ${token}`
  }
});

  const data = await res.json();

  let html = "<h2>Your Redemption History</h2>";

  if (data.length === 0) {
    html += "<p>No redemptions yet.</p>";
  } else {
    html += "<ul>";
    data.forEach(item => {
      html += `
        <li>
          ${item.ItemName} — ${item.Points} points
          <span style="color:#777;">(${new Date(item.RedeemedAt).toLocaleString()})</span>
          <button>View Details</button>
        </li>
      `;
    });
    html += "</ul>";
  }

  document.getElementById("transactionHistory").innerHTML = html;
  // Attach modal listeners to each "View Details" button
const historyButtons = document.querySelectorAll("#transactionHistory button");

historyButtons.forEach((btn, index) => {
  btn.addEventListener("click", () => {
    const item = data[index];

    // Fill modal
    document.getElementById("vItem").textContent = item.ItemName;
    document.getElementById("vPoints").textContent = item.Points;
    document.getElementById("vDate").textContent = new Date(item.RedeemedAt).toLocaleString();
    document.getElementById("vCode").textContent = item.VoucherCode ?? "N/A";

    // Create QR
    const qrContainer = document.getElementById("qrCode");
    qrContainer.innerHTML = "";
    new QRCode(qrContainer, item.VoucherCode ?? "N/A");

    // Show modal
    document.getElementById("voucherModal").style.display = "flex";
  });
});

}

loadHistory();
</script>

<!-- Voucher Modal -->
<div id="voucherModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;">
  
  <div style="
    background:white;
    padding:20px;
    border-radius:10px;
    width:300px;
    text-align:center;">
    
    <h2>Voucher Details</h2>
    <p><strong>Item:</strong> <span id="vItem"></span></p>
    <p><strong>Points:</strong> <span id="vPoints"></span></p>
    <p><strong>Date:</strong> <span id="vDate"></span></p>
    <p><strong>Voucher Code:</strong> <span id="vCode"></span></p>
    <div id="qrCode" style="display:flex; justify-content:center; margin:10px 0;"></div>


    

    <button onclick="document.getElementById('voucherModal').style.display='none'">
      Close
    </button>
  </div>
</div>

<!-- QR generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

 <script src="https://cdn.botpress.cloud/webchat/v3.5/inject.js"></script>
<script src="https://files.bpcontent.cloud/2025/11/22/14/20251122142820-IG7UQ29V.js" defer></script>

</body>
</html>
